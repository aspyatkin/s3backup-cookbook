#!/usr/bin/env sh
TMP_DIR=`mktemp -d`
cd $TMP_DIR
DB_DUMP_FILE=`date +"%Y_%m_%d__%H_%M_%S.sql"`
<% options = @mysqldump_options.map { |k, v| v.nil? ? "--#{k}" : "--#{k}=#{v}" }.join(' ') %>
MYSQL_PWD="<%= @mysql_password %>" mysqldump --host=<%= @mysql_host %> --port=<%= @mysql_port %> --user=<%= @mysql_username %> <%= options %> <%= @mysql_dbname %> > $DB_DUMP_FILE

. <%= @virtualenv_path %>/bin/activate
AWS_ACCESS_KEY_ID=<%= @aws_iam_access_key_id %> AWS_SECRET_ACCESS_KEY=<%= @aws_iam_secret_access_key %> AWS_DEFAULT_REGION=<%= @aws_s3_bucket_region %> AWS_DEFAULT_OUTPUT=text aws s3 cp --no-progress $DB_DUMP_FILE s3://<%= @aws_s3_bucket_name %>/<%= @entry_name %>/$DB_DUMP_FILE
deactivate

rm -rf $TMP_DIR
