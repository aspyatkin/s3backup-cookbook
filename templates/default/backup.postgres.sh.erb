#!/usr/bin/env sh
TMP_DIR=`mktemp -d`
cd $TMP_DIR
DB_DUMP_FILE=`date +"%Y_%m_%d__%H_%M_%S.sql"`
PGPASSWORD="<%= @pg_password %>" pg_dump -h <%= @pg_host %> -p <%= @pg_port %> -U <%= @pg_username %> -d <%= @pg_dbname %> > $DB_DUMP_FILE

<% if @archive %>
RESULT_FILE="$DB_DUMP_FILE.tar.gz"
tar -zcvf $RESULT_FILE $DB_DUMP_FILE
rm $DB_DUMP_FILE
<% else %>
RESULT_FILE="$DB_DUMP_FILE"
<% end %>

. <%= @virtualenv_path %>/bin/activate
AWS_ACCESS_KEY_ID=<%= @aws_iam_access_key_id %> AWS_SECRET_ACCESS_KEY=<%= @aws_iam_secret_access_key %> AWS_DEFAULT_REGION=<%= @aws_s3_bucket_region %> AWS_DEFAULT_OUTPUT=text aws s3 cp --no-progress $RESULT_FILE s3://<%= @aws_s3_bucket_name %>/<%= @entry_name %>/$RESULT_FILE
deactivate

rm -rf $TMP_DIR
