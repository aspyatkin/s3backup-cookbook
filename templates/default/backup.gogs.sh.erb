#! /usr/bin/env sh
TMP_DIR=`mktemp -d`
ARCHIVE_NAME=`date +"%Y_%m_%d__%H_%M_%S.zip"`

cd <%= @gogs_user_home %>
sudo su <%= @gogs_user %> -c "<%= @gogs_work_dir %>/gogs backup --verbose --archive-name $ARCHIVE_NAME"
ARCHIVE_PATH="<%= @gogs_user_home %>/$ARCHIVE_NAME"

if [ ! -f "$ARCHIVE_PATH" ]; then
  echo "An error occured"
  exit 2
fi

ARCHIVE_NEW_PATH="$TMP_DIR/$ARCHIVE_NAME"
sudo mv "$ARCHIVE_PATH" "$ARCHIVE_NEW_PATH"
RUN_USER=`id -un`
RUN_GROUP=`id -gn`
sudo chown "$RUN_USER:$RUN_GROUP" "$ARCHIVE_NEW_PATH"

cd $TMP_DIR
. <%= @virtualenv_path %>/bin/activate
AWS_ACCESS_KEY_ID=<%= @aws_iam_access_key_id %> AWS_SECRET_ACCESS_KEY=<%= @aws_iam_secret_access_key %> AWS_DEFAULT_REGION=<%= @aws_s3_bucket_region %> AWS_DEFAULT_OUTPUT=text aws s3 cp --no-progress $ARCHIVE_NEW_PATH s3://<%= @aws_s3_bucket_name %>/<%= @entry_name %>/$ARCHIVE_NAME
deactivate

rm -rf $TMP_DIR
